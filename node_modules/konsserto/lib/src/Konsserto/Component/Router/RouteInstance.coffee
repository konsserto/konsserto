###
 * This file is part of the Konsserto package.
 *
 * (c) Jessym Reziga <jessym@konsserto.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
###

Tools = use('@Konsserto/Component/Static/Tools')

#
# RouteInstance
#
# @author Jessym Reziga <jessym@konsserto.com>
#
class RouteInstance


	constructor:(@routeDefinition, @controllerDefinition) ->
		@controller = new controllerDefinition
		route = @getDefinition()
		console.log('[Route] ' + @getControllerName()+':' + @getMethod() + ' | pattern: ' +route.getRawPattern())

	setController:(@controller) ->
		return this

	setRouteDefinition:(@routeDefinition) ->
		return this

	setRequest:(@request) ->
		@getController().setRequest(@request)
		return this

	setResponse:(@response) ->
		@getController().setResponse(@response)
		return this

	setControllerDefinition:(@controllerDefinition) ->
		return this

	getDefinition:() ->
		return @routeDefinition

	getController:() ->
		return @controller

	getControllerName:() ->
		return @getController().constructor.name

	getRequest:() ->
		return @request

	getResponse:() ->
		return @response

	setNext:(@next) ->
		@getController().setNext(@next)
		return this

	getNext:() ->
		return @next

	getControllerDefinition:() ->
		return @controllerDefinition

	getMethod:() ->
		return @getDefinition().getMethodName() + 'Action'

	methodExists:() ->
		method = @getMethod()

		if !method? || !@getController()[method]?
			return false

		return true

	getMethodArguments:() ->
		chainArgs = []
		definition = @getDefinition()
		args = Tools.getFunctionParameters(@getControllerDefinition().prototype[@getMethod()])
		params = @getRequest().params

		for arg in args
			if params[arg]?
				chainArgs.push(params[arg])
			else if definition.hasDefaultArg(arg)
				chainArgs.push(definition.getDefaultValueForArg(arg))
			else
				chainArgs.push(null)

		return chainArgs

	getMethodInstance:() ->
		if @getController()[@getMethod()]?
			return @getController()[@getMethod()]

		throw new Error('No method '+@getMethod()+' in controller '+@getDefinition().getControllerName())

	getResponse:() ->
		return Tools.call(@getMethodInstance(),@getMethodArguments())

module.exports = RouteInstance