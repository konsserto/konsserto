cc = use('cli-color')
FactoryAdapter = use('@Konsserto/Component/EntityManager/Adapter/FactoryAdapter')

class EntityManager

  constructor: ()->
    @repositories = []
    @objectToPersist = []
    @loadAdapter()

  getRepository: (repository)->
    splittedRepository = repository.split ':'
    vendor = splittedRepository[0]
    bundle = splittedRepository[1]
    realRepository = splittedRepository[2]
    returnRepository = new (use('/src/' + vendor + '/' + bundle + '/Repositories/' + realRepository))
    returnRepository.setAdapter(@adapter)
    if @adapter
      returnRepository.setAdapter(@adapter)
    return returnRepository

  loadAdapter: ()->
    @adapter = FactoryAdapter.getInstance()

  persist: (object)->
    object.state = 'managed'
    @objectToPersist.push object

  flush: ()->
    for object in @objectToPersist
      if object.state is 'managed'
        repository = @getRepositoryFromObject(object)
        repository.add(repository.getName(), object, (result)->
          object = result
        )
      else
        # manage another state

  getRepositoryFromObject: (object)->
    return @getRepository('MF:TestBundle:UserRepository') # return the repository of the object


module.exports = EntityManager