###
 * This file is part of the Konsserto package.
 *
 * (c) Jessym Reziga <jessym@konsserto.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
###

CONFIG = use('/app/config/config')
Finder = use('@Konsserto/Component/Finder/Finder')
Tools = use('@Konsserto/Component/Static/Tools')

#
# Translator
#
# @author Jessym Reziga <jessym@konsserto.com>
#
class Translator

	constructor: (locale,@application) ->
		@catalogues = {}
		if locale?
			@locale = locale
			@loadCatalogues()


	getLocale:() ->
		if CONFIG['locale']?
			return CONFIG['locale']
		return 'en'

	trans: (id,parameters = {},domain,locale = null) ->

		if !locale?
			locale = @getLocale()

		if !domain?
			domain = 'translations'

		if !@catalogueHasDomainLocale(domain,locale)
			return id

		if @catalogues[domain][locale][id]?
			id = @catalogues[domain][locale][id]

			for key,value of parameters
				eval('id = id.replace(/'+key+'/g,\''+value+'\')')

		return id

	catalogueHasDomainLocale:(domain,locale)->
		if @catalogues[domain]?
			if @catalogues[domain][locale]?
				return true
		return false

	loadCatalogues:()->
		for bundleName,bundle of @application.getBundles()
			domainsFiles = new Finder().files().notRecursive().in(bundle.getTranslationsPath()).ext('.js').end()
			path = bundle.getTranslationsNamespace()+'/'

			for file in domainsFiles
				name = file.getName()
				domainSpecs = name.split('.')

				if domainSpecs.length == 3
					currentDomain = domainSpecs[0]
					currentLocale = domainSpecs[1]
					@catalogues[currentDomain] = {} if !@catalogues[currentDomain]
					@catalogues[currentDomain][currentLocale] = {} if !@catalogues[currentDomain][currentLocale]?
					module = use(path+name)
					@catalogues[currentDomain][currentLocale] = Tools.mergeObjects(@catalogues[currentDomain][currentLocale],module,true)
					@catalogues[currentDomain]['_fromBundle'] = bundleName


module.exports = Translator

